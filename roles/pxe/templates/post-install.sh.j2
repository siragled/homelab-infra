#!/bin/bash
# {{ organization_name }} - Post-Installation Script
# Generated by Ansible - do not edit manually

set -euo pipefail

# Configuration
PXE_SERVER="{{ pxe_next_server }}"
CALLBACK_URL="http://${PXE_SERVER}:{{ callback_api_port }}/register"
SCRIPTS_URL="http://${PXE_SERVER}/scripts"
LOG_FILE="/var/log/pxe-post-install.log"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Error handling
error_exit() {
    log "ERROR: $1"
    exit 1
}

log "Starting post-installation automation..."

# Gather system information
HOSTNAME=$(hostname)
MAC_ADDRESS=$(ip route show default | awk '/default/ { print $5 }' | head -1 | xargs -I{} cat /sys/class/net/{}/address)
IP_ADDRESS=$(ip route get 8.8.8.8 | awk '{print $7; exit}')
ARCHITECTURE=$(uname -m | sed 's/x86_64/amd64/g')
OS_VERSION=$(lsb_release -d | cut -f2)
INSTALLATION_ID="${HOSTNAME}-$(date +%s)-${RANDOM}"

log "System Info:"
log "  Hostname: $HOSTNAME"
log "  MAC: $MAC_ADDRESS" 
log "  IP: $IP_ADDRESS"
log "  Architecture: $ARCHITECTURE"
log "  OS: $OS_VERSION"
log "  Installation ID: $INSTALLATION_ID"

{% if post_install_enabled | bool %}
# Execute post-install scripts
{% for script in post_install_scripts %}
log "Executing {{ script.description }}..."
if curl -s -f "${SCRIPTS_URL}/{{ script.name }}" | bash; then
    log "✓ {{ script.description }} completed successfully"
else
    log "⚠ {{ script.description }} failed, continuing..."
fi

{% endfor %}
{% endif %}

# Register with callback service
log "Registering with PXE callback service..."

PAYLOAD=$(cat <<EOF
{
    "hostname": "$HOSTNAME",
    "mac_address": "$MAC_ADDRESS",
    "ip_address": "$IP_ADDRESS", 
    "architecture": "$ARCHITECTURE",
    "os_version": "$OS_VERSION",
    "installation_id": "$INSTALLATION_ID",
    "hardware_info": {
        "cpu_cores": "$(nproc)",
        "memory_gb": "$(free -g | awk '/^Mem:/{print $2}')",
        "disk_gb": "$(df -BG / | awk 'NR==2{print $2}' | sed 's/G//')"
    }
}
EOF
)

if curl -s -X POST \
    -H "Content-Type: application/json" \
    -d "$PAYLOAD" \
    "$CALLBACK_URL"; then
    log "✓ Successfully registered with callback service"
else
    log "⚠ Failed to register with callback service, but continuing..."
fi

log "Post-installation automation completed!"
log "Node $HOSTNAME is ready for Ansible management"
